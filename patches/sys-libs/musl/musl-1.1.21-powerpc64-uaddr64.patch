From 8ae1a953021d839c7a085fbe6d9872d16689711e Mon Sep 17 00:00:00 2001
From: Samuel Holland <samuel@sholland.org>
Date: Sat, 16 Mar 2019 22:09:35 -0500
Subject: [PATCH] support unaligned relocations on ppc64

Signed-off-by: Samuel Holland <samuel@sholland.org>
---
 arch/powerpc64/reloc.h | 1 +
 ldso/dynlink.c         | 4 ++++
 src/internal/dynlink.h | 1 +
 3 files changed, 6 insertions(+)

diff --git a/arch/powerpc64/reloc.h b/arch/powerpc64/reloc.h
index faf70acd..5bdaeede 100644
--- a/arch/powerpc64/reloc.h
+++ b/arch/powerpc64/reloc.h
@@ -11,6 +11,7 @@
 #define TPOFF_K (-0x7000)
 
 #define REL_SYMBOLIC    R_PPC64_ADDR64
+#define REL_USYMBOLIC   R_PPC64_UADDR64
 #define REL_GOT         R_PPC64_GLOB_DAT
 #define REL_PLT         R_PPC64_JMP_SLOT
 #define REL_RELATIVE    R_PPC64_RELATIVE
diff --git a/ldso/dynlink.c b/ldso/dynlink.c
index 35cacd76..dae066c2 100644
--- a/ldso/dynlink.c
+++ b/ldso/dynlink.c
@@ -407,6 +407,10 @@ static void do_relocs(struct dso *dso, size_t *rel, size_t rel_size, size_t stri
 		case REL_PLT:
 			*reloc_addr = sym_val + addend;
 			break;
+		case REL_USYMBOLIC: {
+			size_t sum = sym_val + addend;
+			memcpy(reloc_addr, &sum, sizeof(*reloc_addr));
+		}
 		case REL_RELATIVE:
 			*reloc_addr = (size_t)base + addend;
 			break;
diff --git a/src/internal/dynlink.h b/src/internal/dynlink.h
index cbe0a6fe..8e825842 100644
--- a/src/internal/dynlink.h
+++ b/src/internal/dynlink.h
@@ -28,6 +28,7 @@ typedef Elf64_Sym Sym;
 enum {
 	REL_NONE = 0,
 	REL_SYMBOLIC = -100,
+	REL_USYMBOLIC,
 	REL_GOT,
 	REL_PLT,
 	REL_RELATIVE,
-- 
2.19.2

