From 3688684f473c97d560bc3ec158e302e612a6e0a4 Mon Sep 17 00:00:00 2001
From: Samuel Holland <samuel@sholland.org>
Date: Thu, 10 Oct 2019 20:20:42 -0500
Subject: [PATCH 5/5] [Clang] Use the ELFv2 ABI for musl on both endians

---
 clang/lib/Basic/Targets/PPC.h         | 5 ++++-
 clang/lib/Driver/ToolChains/Clang.cpp | 2 +-
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git clang/lib/Basic/Targets/PPC.h clang/lib/Basic/Targets/PPC.h
index 6e5df097921..3365965da39 100644
--- clang/lib/Basic/Targets/PPC.h
+++ clang/lib/Basic/Targets/PPC.h
@@ -379,7 +379,10 @@ public:
       ABI = "elfv2";
     } else {
       resetDataLayout("E-m:e-i64:64-n32:64");
-      ABI = Triple.getEnvironment() == llvm::Triple::ELFv2 ? "elfv2" : "elfv1";
+      if (Triple.getEnvironment() == llvm::Triple::ELFv2 || Triple.isMusl())
+        ABI = "elfv2";
+      else
+        ABI = "elfv1";
     }
 
     if (Triple.getOS() == llvm::Triple::AIX)
diff --git clang/lib/Driver/ToolChains/Clang.cpp clang/lib/Driver/ToolChains/Clang.cpp
index dd461a1976d..1d08817f5f7 100644
--- clang/lib/Driver/ToolChains/Clang.cpp
+++ clang/lib/Driver/ToolChains/Clang.cpp
@@ -1804,7 +1804,7 @@ void Clang::AddPPCTargetArgs(const ArgList &Args,
         break;
       }
 
-      ABIName = "elfv1";
+      ABIName = getToolChain().getTriple().isMusl() ? "elfv2" : "elfv1";
       break;
     }
     case llvm::Triple::ppc64le:
-- 
2.21.0

